{% extends "base.html" %}

{% block title %}Run: {{ run.run_id[:8] }} - Data ETL Tooling{% endblock %}

{% block content %}
<article>
    <header>
        <hgroup>
            <h1>Run: {{ run.run_id[:16] }}...</h1>
            {% include "runs/_status_fragment.html" %}
        </hgroup>
    </header>

    <!-- Details -->
    <h2>Details</h2>
    <figure>
        <table>
            <tbody>
                <tr>
                    <td><strong>Run ID</strong></td>
                    <td><code>{{ run.run_id }}</code></td>
                </tr>
                <tr>
                    <td><strong>Job</strong></td>
                    <td><code>{{ run.job_name }}</code></td>
                </tr>
                <tr>
                    <td><strong>Status</strong></td>
                    <td>{{ run.status }}</td>
                </tr>
                <tr>
                    <td><strong>Started</strong></td>
                    <td>{{ run.started_at or '-' }}</td>
                </tr>
                <tr>
                    <td><strong>Ended</strong></td>
                    <td>{{ run.ended_at or '-' }}</td>
                </tr>
                {% if run.batch_id %}
                <tr>
                    <td><strong>Batch ID</strong></td>
                    <td><a href="/manifests/{{ run.batch_id }}">{{ run.batch_id }}</a></td>
                </tr>
                {% endif %}
                {% if run.intent %}
                <tr>
                    <td><strong>Intent</strong></td>
                    <td><code>{{ run.intent }}</code></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </figure>

    <!-- Error -->
    {% if run.error_message %}
    <h2>Error</h2>
    {% set msg = run.error_message|lower %}
    {% if 'validation error' in msg or 'missing required' in msg %}
        {% set badge_class = 'badge-warning' %}
        {% set badge_text = 'VALIDATION' %}
        {% set suggestion = 'Check your manifest metadata or file format.' %}
    {% elif 'file not found' in msg or 'nosuchkey' in msg or 's3' in msg %}
        {% set badge_class = 'badge-warning' %}
        {% set badge_text = 'MISSING FILE' %}
        {% set suggestion = 'Ensure the file path in your manifest exists in MinIO.' %}
    {% elif 'postgres' in msg or 'postgis' in msg %}
        {% set badge_class = 'badge-error' %}
        {% set badge_text = 'DATABASE' %}
        {% set suggestion = 'A database error occurred. Check input geometry validity.' %}
    {% elif 'timeout' in msg or 'timed out' in msg %}
        {% set badge_class = 'badge-warning' %}
        {% set badge_text = 'TIMEOUT' %}
        {% set suggestion = 'The operation took too long. Try a smaller dataset or optimized recipe.' %}
    {% else %}
        {% set badge_class = 'badge-unknown' %}
        {% set badge_text = 'UNKNOWN' %}
        {% set suggestion = 'Review the logs for full traceback. Retry if transient.' %}
    {% endif %}

    <div class="error-analysis">
        <div class="error-header">
            <span class="badge {{ badge_class }}">{{ badge_text }}</span>
            <span class="error-suggestion"><strong>Suggestion:</strong> {{ suggestion }}</span>
        </div>
        <pre class="error-trace">{{ run.error_message }}</pre>
    </div>
    {% endif %}

    <!-- Tags -->
    {% if run.tags %}
    <h2>Tags</h2>
    <figure>
        <table>
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in run.tags.items() %}
                <tr>
                    <td><code>{{ key }}</code></td>
                    <td>{{ value }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>
    {% endif %}

    <!-- Events -->
    <h2>Events ({{ events|length }})</h2>
    {% if events %}
    <details>
        <summary>Show all events</summary>
        <figure>
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Step</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in events %}
                    <tr
                        class="{% if 'FAILURE' in (e.event_type or '') %}error-row{% elif 'SUCCESS' in (e.event_type or '') %}success-row{% endif %}">
                        <td><small>{{ e.timestamp[11:19] if e.timestamp else '-' }}</small></td>
                        <td><small><code>{{ e.event_type }}</code></small></td>
                        <td><small>{{ e.step_key or '-' }}</small></td>
                        <td><small>{{ e.message[:100] }}{% if e.message|length > 100 %}...{% endif %}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </figure>
    </details>
    {% else %}
    <p><em>No events recorded.</em></p>
    {% endif %}
</article>

<style>
    .error-analysis {
        background-color: var(--pico-card-background-color);
        border: 1px solid var(--pico-muted-border-color);
        border-radius: var(--pico-border-radius);
        padding: 1rem;
        margin-top: 0.5rem;
    }
    .error-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }
    .error-suggestion {
        font-size: 0.875rem;
        color: var(--pico-muted-color);
    }
    .error-trace {
        margin-bottom: 0;
        max-height: 300px;
        overflow-y: auto;
        font-size: 0.85rem;
    }
    .events-table {
        font-size: 0.85rem;
    }

    .error-row {
        background-color: rgba(255, 0, 0, 0.1);
    }

    .success-row {
        background-color: rgba(0, 255, 0, 0.05);
    }
</style>
{% endblock %}