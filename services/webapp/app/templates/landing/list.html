{% extends "base.html" %}

{% block title %}Landing Zone - Data ETL Tooling{% endblock %}

{% block content %}
<article>
    <header>
        <hgroup>
            <h1>üìÅ Landing Zone</h1>
            <p>Browse, upload, and manage files in the landing zone.</p>
        </hgroup>
    </header>

    <!-- Upload Form -->
    <details open>
        <summary role="button" class="secondary">Upload New File</summary>
        <form id="upload-form" enctype="multipart/form-data">
            <div class="grid">
                <label>
                    File
                    <input type="file" name="file" id="file-input" required>
                </label>
                <label>
                    Prefix (optional)
                    <input type="text" name="prefix" placeholder="e.g., batch_001">
                </label>
            </div>
            <button type="submit">Upload</button>
        </form>
        <div id="upload-status"></div>
    </details>

    <!-- File Browser -->
    <h2>Files ({{ files|length }})</h2>

    {% if prefix %}
    <p>
        <a href="/landing/?prefix=">‚Üê Back to root</a> |
        Current: <code>{{ prefix }}</code>
    </p>
    {% endif %}

    {% if files %}
    <figure>
        <table class="file-list">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td>
                        {% if file.is_dir %}
                        üìÅ <a href="/landing/?prefix={{ file.key }}">{{ file.key }}</a>
                        {% else %}
                        üìÑ {{ file.key }}
                        {% endif %}
                    </td>
                    <td>{{ file.size|filesizeformat if file.size else '-' }}</td>
                    <td>{{ file.last_modified[:19] if file.last_modified else '-' }}</td>
                    <td>
                        {% if not file.is_dir %}
                        <a href="/landing/download/{{ file.key }}" role="button" class="outline contrast"
                            style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Download</a>
                        {% if not file.key.startswith('archive/') %}
                        <button class="delete-btn outline secondary" data-key="{{ file.key }}"
                            style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Delete</button>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>
    {% else %}
    <p><em>No files found{% if prefix %} in <code>{{ prefix }}</code>{% endif %}.</em></p>
    {% endif %}
</article>

<script>
    // Upload form handling
    document.getElementById('upload-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const status = document.getElementById('upload-status');

        status.innerHTML = '<p aria-busy="true">Uploading...</p>';

        try {
            const prefix = formData.get('prefix') || '';
            const url = '/landing/upload' + (prefix ? '?prefix=' + encodeURIComponent(prefix) : '');

            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                status.innerHTML = '<p class="success">‚úÖ ' + result.message + '</p>';
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                status.innerHTML = '<p class="error">‚ùå ' + (error.detail || 'Upload failed') + '</p>';
            }
        } catch (err) {
            status.innerHTML = '<p class="error">‚ùå Upload failed: ' + err.message + '</p>';
        }
    });

    // Delete buttons
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const key = this.dataset.key;
            if (!confirm('Delete ' + key + '?')) return;

            try {
                const response = await fetch('/landing/delete/' + encodeURIComponent(key), {
                    method: 'POST'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Delete failed: ' + (error.detail || 'Unknown error'));
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        });
    });
</script>

<style>
    .success {
        color: var(--pico-color-green-550);
    }

    .error {
        color: var(--pico-color-red-550);
    }
</style>
{% endblock %}