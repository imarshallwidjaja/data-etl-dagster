{% extends "base.html" %}
{% import 'macros/forms.html' as forms %}

{% block title %}New Join Manifest - Data ETL Tooling{% endblock %}

{% block content %}
{{ forms.field_error_styles() }}
<article>
    <header>
        <hgroup>
            <h1>ðŸ”— New Join Manifest</h1>
            <p>Join existing spatial and tabular assets.</p>
        </hgroup>
    </header>

    <div class="grid" style="margin-bottom: 2rem;">
        <button type="button" id="form-mode-btn" class="active">Form Mode</button>
        <button type="button" id="json-mode-btn" class="secondary outline">JSON Mode</button>
    </div>

    <div id="form-mode">
        <form id="manifest-form" method="post">
            <fieldset>
                <legend>Output Dataset Information</legend>

                {{ forms.render_text_field('title', 'Title', required=True, placeholder='Human-readable title for the joined output') }}

                {{ forms.render_textarea_field('description', 'Description', rows=2, placeholder='Describe the joined output dataset') }}

                {{ forms.render_text_field('keywords', 'Keywords (comma-separated)', placeholder='joined, spatial, census', description='Subject keywords for discovery') }}

                {{ forms.render_text_field('source', 'Source', placeholder='Data lineage/provenance statement') }}

                <div class="grid">
                    {% set license_options = [
                        {'value': '', 'label': 'Select license...'},
                        {'value': 'CC-BY-4.0', 'label': 'CC-BY-4.0'},
                        {'value': 'CC-BY-SA-4.0', 'label': 'CC-BY-SA-4.0'},
                        {'value': 'CC0-1.0', 'label': 'CC0 (Public Domain)'},
                        {'value': 'MIT', 'label': 'MIT'},
                        {'value': 'proprietary', 'label': 'Proprietary'}
                    ] %}
                    {{ forms.render_select_field('license', 'License', license_options) }}

                    {{ forms.render_text_field('attribution', 'Attribution', placeholder='Credit statement') }}
                </div>
            </fieldset>

            <fieldset>
                <legend>Basic Information</legend>

                {{ forms.render_text_field('batch_id', 'Batch ID (optional)', placeholder=suggested_batch_id, description='Leave blank to auto-generate', value='') }}

                {{ forms.render_text_field('project', 'Project', placeholder='e.g., SPATIAL_CENSUS_JOIN', description='Optional project identifier') }}

                {{ forms.render_text_field('dataset_id', 'Dataset ID (optional)', placeholder='Auto-generated if blank') }}
            </fieldset>

            <fieldset>
                <legend>Join Configuration</legend>

                <div class="grid">
                    {% set spatial_opts = [{'value': '', 'label': 'Select spatial asset...'}] %}
                    {% for asset in spatial_assets %}
                        {% set _ = spatial_opts.append({'value': asset.dataset_id, 'label': asset.dataset_id ~ ' (v' ~ asset.version ~ ')'}) %}
                    {% endfor %}
                    {{ forms.render_select_field('spatial_dataset_id', 'Spatial Asset', spatial_opts, required=True) }}

                    {% set tabular_opts = [{'value': '', 'label': 'Select tabular asset...'}] %}
                    {% for asset in tabular_assets %}
                        {% set _ = tabular_opts.append({'value': asset.dataset_id, 'label': asset.dataset_id ~ ' (v' ~ asset.version ~ ')'}) %}
                    {% endfor %}
                    {{ forms.render_select_field('tabular_dataset_id', 'Tabular Asset', tabular_opts, required=True) }}
                </div>

                <div class="grid">
                    {{ forms.render_text_field('left_key', 'Left Key (Tabular)', required=True, placeholder='e.g., parcel_id') }}

                    {{ forms.render_text_field('right_key', 'Right Key (Spatial)', placeholder='Defaults to left key') }}

                    {% set how_opts = [
                        {'value': 'left', 'label': 'Left'},
                        {'value': 'inner', 'label': 'Inner'},
                        {'value': 'right', 'label': 'Right'},
                        {'value': 'outer', 'label': 'Outer'}
                    ] %}
                    {{ forms.render_select_field('how', 'Join Type', how_opts, value='left') }}
                </div>
            </fieldset>

            <div id="submit-status"></div>
            <button type="submit">Create Manifest</button>
        </form>
    </div>

    <div id="json-mode" style="display: none;">
        <label for="json-input">Manifest JSON (ManifestCreateRequest format)</label>
        <textarea id="json-input" rows="15" placeholder='{
    "title": "My Joined Dataset",
    "intent": "join_datasets",
    "join_config": {
        "spatial_dataset_id": "...",
        "tabular_dataset_id": "...",
        "left_key": "..."
    }
}'></textarea>
        <div id="json-status"></div>
        <button type="button" id="json-submit-btn">Validate & Submit JSON</button>
    </div>
</article>

<script src="/static/js/validation.js"></script>
<script>
    const validator = new ManifestFormValidator('manifest-form', 'joined');

    // Mode toggle
    const formModeBtn = document.getElementById('form-mode-btn');
    const jsonModeBtn = document.getElementById('json-mode-btn');
    const formDiv = document.getElementById('form-mode');
    const jsonDiv = document.getElementById('json-mode');

    formModeBtn.addEventListener('click', () => {
        formDiv.style.display = 'block';
        jsonDiv.style.display = 'none';
        formModeBtn.classList.remove('secondary', 'outline');
        formModeBtn.classList.add('active');
        jsonModeBtn.classList.add('secondary', 'outline');
        jsonModeBtn.classList.remove('active');
    });

    jsonModeBtn.addEventListener('click', () => {
        formDiv.style.display = 'none';
        jsonDiv.style.display = 'block';
        jsonModeBtn.classList.remove('secondary', 'outline');
        jsonModeBtn.classList.add('active');
        formModeBtn.classList.add('secondary', 'outline');
        formModeBtn.classList.remove('active');
    });
    
    document.getElementById('manifest-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const status = document.getElementById('submit-status');
        status.innerHTML = '<p aria-busy="true">Creating manifest...</p>';

        const formData = new FormData(e.target);
        const data = {
            batch_id: formData.get('batch_id') || null,
            title: formData.get('title'),
            description: formData.get('description') || '',
            keywords: (formData.get('keywords') || '').split(',').map(k => k.trim()).filter(Boolean),
            source: formData.get('source') || '',
            license: formData.get('license') || '',
            attribution: formData.get('attribution') || '',
            project: formData.get('project') || null,
            dataset_id: formData.get('dataset_id') || null,
            join_config: {
                spatial_dataset_id: formData.get('spatial_dataset_id'),
                tabular_dataset_id: formData.get('tabular_dataset_id'),
                left_key: formData.get('left_key'),
                right_key: formData.get('right_key') || null,
                how: formData.get('how')
            }
        };

        try {
            const response = await fetch('/manifests/new/joined', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                status.innerHTML = '<p class="success">Manifest created: ' + result.batch_id + '</p>';
                setTimeout(() => window.location.href = '/manifests/', 1500);
            } else {
                const error = await response.json();
                status.innerHTML = '<p class="error">' + (error.detail || 'Creation failed') + '</p>';
            }
        } catch (err) {
            status.innerHTML = '<p class="error">' + err.message + '</p>';
        }
    });

    // JSON Submit
    document.getElementById('json-submit-btn').addEventListener('click', async function() {
        const textarea = document.getElementById('json-input');
        const status = document.getElementById('json-status');
        status.innerHTML = '<p aria-busy="true">Validating JSON...</p>';

        let data;
        try {
            data = JSON.parse(textarea.value);
        } catch (e) {
            status.innerHTML = '<p class="error">Invalid JSON: ' + e.message + '</p>';
            return;
        }

        // Fetch schema and validate with Ajv
        try {
            const schemaRes = await fetch('/manifests/schemas/joined');
            const schema = await schemaRes.json();
            const ajv = new Ajv({allErrors: true, strict: false});
            const validate = ajv.compile(schema);
            
            if (!validate(data)) {
                const errors = validate.errors.map(e => (e.instancePath || 'root') + ': ' + e.message).join('; ');
                status.innerHTML = '<p class="error">Validation failed: ' + errors + '</p>';
                return;
            }

            status.innerHTML = '<p aria-busy="true">Submitting...</p>';
            const response = await fetch('/manifests/new/joined', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                status.innerHTML = '<p class="success">Manifest created: ' + result.batch_id + '</p>';
                setTimeout(() => window.location.href = '/manifests/', 1500);
            } else {
                const error = await response.json();
                status.innerHTML = '<p class="error">' + (error.detail || 'Submission failed') + '</p>';
            }
        } catch (err) {
            status.innerHTML = '<p class="error">' + err.message + '</p>';
        }
    });
</script>

<style>
    .success { color: var(--pico-color-green-550); }
    .error { color: var(--pico-color-red-550); }
</style>
{% endblock %}
