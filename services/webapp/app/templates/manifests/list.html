{% extends "base.html" %}

{% block title %}Manifests - Data ETL Tooling{% endblock %}

{% block content %}
<article>
    <header>
        <hgroup>
            <h1>ðŸ“‹ Manifests</h1>
            <p>View and manage pipeline manifests.</p>
        </hgroup>
        <a href="/manifests/new" role="button">+ New Manifest</a>
    </header>

    <!-- Filter -->
    <form method="get" class="grid">
        <label>
            Status
            <select name="status" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="running" {% if status=='running' %}selected{% endif %}>Running</option>
                <option value="success" {% if status=='success' %}selected{% endif %}>Success</option>
                <option value="failure" {% if status=='failure' %}selected{% endif %}>Failure</option>
                <option value="canceled" {% if status=='canceled' %}selected{% endif %}>Canceled</option>
            </select>
        </label>
    </form>

    <!-- Manifest List -->
    <h2>Manifests ({{ manifests|length }})</h2>

    {% if manifests %}
    <figure>
        <table>
            <thead>
                <tr>
                    <th>Batch ID</th>
                    <th>Intent</th>
                    <th>Status</th>
                    <th>Project</th>
                    <th>Files</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for m in manifests %}
                <tr>
                    <td><a href="/manifests/{{ m.batch_id }}">{{ m.batch_id }}</a></td>
                    <td><code>{{ m.intent }}</code></td>
                    <td>
                        {% if m.status == 'success' %}
                        <span class="badge badge-success">{{ m.status }}</span>
                        {% elif m.status == 'failure' %}
                        <span class="badge badge-error">{{ m.status }}</span>
                        {% elif m.status == 'running' %}
                        <span class="badge badge-warning">{{ m.status }}</span>
                        {% elif m.status == 'canceled' %}
                        <span class="badge badge-pending">{{ m.status }}</span>
                        {% else %}
                        <span class="badge badge-unknown">{{ m.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ m.project or '-' }}</td>
                    <td>{{ m.file_count }}</td>
                    <td>{{ m.created_at[:19] if m.created_at else '-' }}</td>
                    <td>
                        <a href="/manifests/{{ m.batch_id }}" role="button" class="outline contrast btn-sm">View</a>
                        {% if m.dagster_run_id %}
                        <a href="/runs/{{ m.dagster_run_id }}" role="button" class="outline btn-sm">Run</a>
                        {% endif %}
                        {% if m.status in ['success', 'failure'] %}
                        <button class="secondary outline btn-sm rerun-btn" data-batch-id="{{ m.batch_id }}">Re-run</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>
    {% else %}
    <p><em>No manifests found{% if status %} with status "{{ status }}"{% endif %}.</em></p>
    <p><a href="/manifests/new" role="button">Create your first manifest â†’</a></p>
    {% endif %}

    <!-- Action Status Toast -->
    <div id="action-status" class="action-toast"></div>
</article>

<script>
    // Re-run button handlers
    document.querySelectorAll('.rerun-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
            const batchId = this.getAttribute('data-batch-id');
            const status = document.getElementById('action-status');
            const originalText = this.textContent;
            
            // Disable button and show loading state
            this.disabled = true;
            this.setAttribute('aria-busy', 'true');
            this.textContent = 'Re-running...';
            
            try {
                const response = await fetch('/manifests/' + batchId + '/rerun', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    status.innerHTML = '<p class="success">' + result.message + '</p>';
                    status.classList.add('visible');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const error = await response.json();
                    status.innerHTML = '<p class="error">' + (error.detail || 'Re-run failed') + '</p>';
                    status.classList.add('visible');
                    this.disabled = false;
                    this.removeAttribute('aria-busy');
                    this.textContent = originalText;
                }
            } catch (err) {
                status.innerHTML = '<p class="error">' + err.message + '</p>';
                status.classList.add('visible');
                this.disabled = false;
                this.removeAttribute('aria-busy');
                this.textContent = originalText;
            }
            
            // Auto-hide status after 5 seconds on error
            setTimeout(() => status.classList.remove('visible'), 5000);
        });
    });
</script>

<style>
    .action-toast {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        background: var(--pico-card-background-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateY(1rem);
        transition: opacity 0.3s, transform 0.3s;
        z-index: 1000;
    }
    
    .action-toast.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    .action-toast .success {
        color: var(--pico-color-green-550);
        margin: 0;
    }
    
    .action-toast .error {
        color: var(--pico-color-red-550);
        margin: 0;
    }
</style>
{% endblock %}