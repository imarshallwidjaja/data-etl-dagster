{% extends "base.html" %}

{% block title %}{{ asset.metadata.title or asset.dataset_id }} — Lineage{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/cytoscape@3.28.0/dist/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
{% endblock %}

{% block content %}
<h1>{{ asset.metadata.title or asset.dataset_id }} — Lineage</h1>

<p>
    <a href="/assets/{{ asset.dataset_id }}">← Back to Asset</a>
</p>

<div id="cy" style="min-height: 500px; width: 100%; border: 1px solid var(--pico-muted-border-color); border-radius: 4px;"></div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const resp = await fetch('/assets/{{ asset.dataset_id }}/v{{ asset.version }}/lineage/graph');
    if (!resp.ok) {
        console.error('Failed to load lineage graph:', resp.status);
        document.getElementById('cy').innerHTML = '<p style="padding: 2rem; text-align: center;">Failed to load lineage graph</p>';
        return;
    }
    const graphData = await resp.json();

    cytoscape.use(cytoscapeDagre);

    cytoscape({
        container: document.getElementById('cy'),
        elements: graphData.elements,
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(title)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'background-color': '#6c757d',
                    'color': '#fff',
                    'text-wrap': 'wrap',
                    'text-max-width': '100px',
                    'width': 120,
                    'height': 60,
                    'shape': 'roundrectangle',
                    'font-size': '10px',
                }
            },
            {
                selector: 'node[?is_root]',
                style: {
                    'background-color': '#0d6efd',
                    'border-width': 3,
                    'border-color': '#0a58ca',
                }
            },
            {
                selector: 'node[kind="spatial"]',
                style: { 'background-color': '#198754', 'color': '#fff' }
            },
            {
                selector: 'node[kind="tabular"]',
                style: { 'background-color': '#fd7e14', 'color': '#000' }
            },
            {
                selector: 'node[kind="joined"]',
                style: { 'background-color': '#6f42c1', 'color': '#fff' }
            },
            {
                selector: 'node[?is_root][kind="spatial"]',
                style: {
                    'background-color': '#198754',
                    'color': '#fff',
                    'border-width': 3,
                    'border-color': '#0a58ca',
                }
            },
            {
                selector: 'node[?is_root][kind="tabular"]',
                style: {
                    'background-color': '#fd7e14',
                    'color': '#000',
                    'border-width': 3,
                    'border-color': '#0a58ca',
                }
            },
            {
                selector: 'node[?is_root][kind="joined"]',
                style: {
                    'background-color': '#6f42c1',
                    'color': '#fff',
                    'border-width': 3,
                    'border-color': '#0a58ca',
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#adb5bd',
                    'target-arrow-color': '#adb5bd',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(transformation)',
                    'font-size': '8px',
                    'color': '#adb5bd',
                    'text-rotation': 'autorotate',
                    'text-margin-y': -10,
                }
            }
        ],
        layout: {
            name: 'dagre',
            rankDir: 'TB',
            nodeSep: 50,
            rankSep: 80,
        }
    });
});
</script>
{% endblock %}
