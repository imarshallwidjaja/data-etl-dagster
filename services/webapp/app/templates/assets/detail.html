{% extends "base.html" %}

{% block title %}Asset: {{ asset.metadata.title or asset.dataset_id }} - Data ETL Tooling{% endblock %}

{% block content %}
<article>
    <header>
        <h1>{{ asset.metadata.title or asset.dataset_id }}</h1>
        <p>
            {% if asset.kind == 'spatial' %}
            Spatial Asset
            {% elif asset.kind == 'tabular' %}
            Tabular Asset
            {% elif asset.kind == 'joined' %}
            Joined Asset
            {% else %}
            {{ asset.kind }}
            {% endif %}
        </p>
    </header>

    <h2>Latest Version (v{{ asset.version }})</h2>
    <figure>
        <table>
            <tbody>
                <tr>
                    <td><strong>Dataset ID</strong></td>
                    <td><code>{{ asset.dataset_id }}</code></td>
                </tr>
                <tr>
                    <td><strong>Version</strong></td>
                    <td>{{ asset.version }}</td>
                </tr>
                <tr>
                    <td><strong>Kind</strong></td>
                    <td>{{ asset.kind }}</td>
                </tr>
                <tr>
                    <td><strong>S3 Key</strong></td>
                    <td><code>{{ asset.s3_key }}</code></td>
                </tr>
                <tr>
                    <td><strong>Content Hash</strong></td>
                    <td><code>{{ asset.content_hash[:16] if asset.content_hash else '-' }}...</code></td>
                </tr>
                <tr>
                    <td><strong>Created</strong></td>
                    <td>{{ asset.created_at[:19] if asset.created_at else '-' }}</td>
                </tr>
            </tbody>
        </table>
    </figure>

    <div class="grid">
        <a href="/assets/{{ asset.dataset_id }}/v{{ asset.version }}/download" role="button">Download Latest</a>
        <a href="/assets/{{ asset.dataset_id }}/v{{ asset.version }}/lineage" role="button" class="secondary">View
            Lineage</a>
    </div>

    <section>
        <h2>Metadata</h2>
        <dl>
            <dt>Description</dt>
            <dd>{{ description_html|safe }}</dd>

            <dt>Keywords</dt>
            <dd>
                {% for kw in asset.metadata.keywords or [] %}
                <kbd>{{ kw }}</kbd>
                {% else %}
                <em>None</em>
                {% endfor %}
            </dd>

            <dt>Source</dt>
            <dd>{{ asset.metadata.source or 'Not specified' }}</dd>

            <dt>License</dt>
            <dd>{{ asset.metadata.license or 'Not specified' }}</dd>

            <dt>Attribution</dt>
            <dd>{{ asset.metadata.attribution or 'Not specified' }}</dd>
        </dl>
    </section>

    {% if asset.kind in ['spatial', 'joined'] %}
    <section>
        <h2>Spatial Information</h2>
        <dl>
            <dt>CRS</dt>
            <dd>{{ asset.crs or 'Not specified' }}</dd>

            <dt>Bounds</dt>
            <dd>
                {% if asset.bounds %}
                [{{ asset.bounds.minx }}, {{ asset.bounds.miny }}] â€“ [{{ asset.bounds.maxx }}, {{ asset.bounds.maxy }}]
                {% else %}
                Not available
                {% endif %}
            </dd>

            <dt>Geometry Type</dt>
            <dd>{{ asset.metadata.geometry_type or 'Not specified' }}</dd>
        </dl>
    </section>
    {% endif %}

    {% if asset.metadata.column_schema %}
    <section>
        <h2>Column Schema</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Logical Type</th>
                    <th>Nullable</th>
                </tr>
            </thead>
            <tbody>
                {% for col_name, col_info in asset.metadata.column_schema.items() %}
                <tr>
                    <td><code>{{ col_name }}</code></td>
                    <td>{{ col_info.title or col_name }}</td>
                    <td>{{ col_info.description or '' }}</td>
                    <td>{{ col_info.type_name }}</td>
                    <td>{{ col_info.logical_type }}</td>
                    <td>{{ 'Yes' if col_info.nullable else 'No' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    <h2>All Versions ({{ versions|length }})</h2>
    {% if versions %}
    <figure>
        <table>
            <thead>
                <tr>
                    <th>Version</th>
                    <th>S3 Key</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for v in versions %}
                <tr>
                    <td>v{{ v.version }}</td>
                    <td><code>{{ v.s3_key }}</code></td>
                    <td>{{ v.created_at[:19] if v.created_at else '-' }}</td>
                    <td>
                        <a href="/assets/{{ asset.dataset_id }}/v{{ v.version }}/download" role="button" class="outline btn-sm">Download</a>
                        <a href="/assets/{{ asset.dataset_id }}/v{{ v.version }}/lineage" role="button"
                            class="outline secondary btn-sm">Lineage</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>
    {% else %}
    <p><em>No version history available.</em></p>
    {% endif %}
</article>
{% endblock %}
