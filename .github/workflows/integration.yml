# =============================================================================
# Test Suite Workflow
# =============================================================================
# Runs unit tests (no Docker required) and integration tests (full stack)
# - Unit tests: Fast feedback on models, validation, and business logic
# - Integration tests: Connectivity and operations against live services
# =============================================================================

name: Test Suite

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    
    env:
      # Use CI-safe defaults from .env.ci
      ENVIRONMENT: ci
      COMPOSE_PROJECT_NAME: spatial-etl-ci
      
      # MinIO Configuration
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio_password
      MINIO_ENDPOINT: localhost:9000
      MINIO_USE_SSL: "false"
      MINIO_LANDING_BUCKET: landing-zone
      MINIO_LAKE_BUCKET: data-lake
      
      # MongoDB Configuration
      MONGO_INITDB_ROOT_USERNAME: mongo
      MONGO_INITDB_ROOT_PASSWORD: mongo_password
      MONGO_HOST: localhost
      MONGO_PORT: "27017"
      MONGO_DATABASE: spatial_etl
      
      # PostGIS Configuration
      POSTGRES_USER: postgis
      POSTGRES_PASSWORD: postgis_password
      POSTGRES_DB: spatial_compute
      POSTGRES_HOST: localhost
      POSTGRES_PORT: "5432"
      
      # Dagster Configuration
      DAGSTER_HOME: /opt/dagster/dagster_home
      DAGSTER_POSTGRES_USER: dagster
      DAGSTER_POSTGRES_PASSWORD: dagster_password
      DAGSTER_POSTGRES_DB: dagster
      DAGSTER_POSTGRES_HOST: localhost
      DAGSTER_POSTGRES_PORT: "5433"
      DAGSTER_WEBSERVER_HOST: 0.0.0.0
      DAGSTER_WEBSERVER_PORT: "3000"
      
      # Service wait timeout (seconds)
      SERVICE_WAIT_TIMEOUT: "120"
      
      # Logging
      LOG_LEVEL: INFO
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect changed areas
        id: changes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            unit:
              - 'services/**'
              - 'libs/**'
              - 'tests/unit/**'
              - 'requirements*.txt'
              - '.github/workflows/integration.yml'
            integration:
              - 'docker-compose.yaml'
              - 'scripts/**'
              - 'tests/integration/**'
              - 'services/**'
              - 'libs/**'
              - '.github/workflows/integration.yml'
      
      - name: Set up Python
        if: ${{ steps.changes.outputs.unit == 'true' || steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      
      - name: Install dependencies
        if: ${{ steps.changes.outputs.unit == 'true' || steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
      
      - name: Run unit tests
        if: ${{ steps.changes.outputs.unit == 'true' || github.event_name == 'workflow_dispatch' }}
        run: |
          pytest tests/unit -v --tb=short
        timeout-minutes: 5
      
      - name: Start Docker stack
        if: ${{ steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch' }}
        run: |
          docker compose -f docker-compose.yaml up -d --build \
            dagster-webserver dagster-daemon user-code minio minio-init mongodb postgis dagster-postgres
      
      - name: Wait for services to be ready
        if: ${{ steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch' }}
        run: |
          python scripts/wait_for_services.py
        timeout-minutes: 5
      
      - name: Run integration tests
        if: ${{ steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch' }}
        run: |
          pytest -m integration tests/integration -v
        timeout-minutes: 10
      
      - name: Dump service logs on failure
        if: failure() && (steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch')
        run: |
          echo "=== Dagster Webserver Logs ==="
          docker compose -f docker-compose.yaml logs dagster-webserver || true
          echo ""
          echo "=== Dagster Daemon Logs ==="
          docker compose -f docker-compose.yaml logs dagster-daemon || true
          echo ""
          echo "=== User Code Logs ==="
          docker compose -f docker-compose.yaml logs user-code || true
          echo ""
          echo "=== MinIO Logs ==="
          docker compose -f docker-compose.yaml logs minio || true
          echo ""
          echo "=== MongoDB Logs ==="
          docker compose -f docker-compose.yaml logs mongodb || true
          echo ""
          echo "=== PostGIS Logs ==="
          docker compose -f docker-compose.yaml logs postgis || true
          echo ""
          echo "=== All Container Status ==="
          docker compose -f docker-compose.yaml ps || true
      
      - name: Cleanup
        if: always() && (steps.changes.outputs.integration == 'true' || github.event_name == 'workflow_dispatch')
        run: |
          docker compose -f docker-compose.yaml down -v

